{% extends 'base.html' %}

{% block content %}
<main class="p-4 md:p-8 overflow-y-auto relative space-y-6">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="relative w-full md:w-96">
            <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-500"></i>
            <input type="text" placeholder="Search sensors..." class="w-full bg-gray-800 rounded-full py-2.5 pl-10 pr-4 focus:outline-none focus:ring-1 focus:ring-purple-500">
        </div>
        <div class="flex items-center gap-4 md:justify-end">
            <button class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 relative">
                <i class="ph ph-bell"></i>
                <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            <div class="w-8 h-8 rounded-full bg-gray-700"></div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 neo-card p-6 relative overflow-hidden group">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-gray-400 text-sm">Parking Space</h2>
                    <h1 class="text-4xl font-bold mt-1">203</h1>
                    <p class="text-xs text-gray-500">Realtime Detection</p>
                </div>
                <span class="px-3 py-1 bg-purple-600/30 text-purple-300 text-xs rounded-full border border-purple-500/50">Zone A</span>
            </div>
            <div class="h-64 w-full flex items-center justify-center relative">
                <!-- Simple CSS representation of the parking lot -->
                <div class="transform rotate-x-60 rotate-z-45 perspective-1000">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="w-16 h-24 bg-gray-700 rounded-lg border-2 border-dashed border-gray-500 flex items-center justify-center">
                            <i class="ph ph-car text-3xl text-gray-500"></i>
                        </div>
                        <div class="w-16 h-24 bg-purple-600 rounded-lg shadow-[0_10px_20px_rgba(147,51,234,0.5)] flex items-center justify-center border-2 border-purple-400">
                            <i class="ph ph-car-profile text-3xl text-white"></i>
                        </div>
                        <div class="w-16 h-24 bg-gray-700 rounded-lg border-2 border-dashed border-gray-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accuracy / Occupancy Chart -->
        <div class="neo-card p-6 flex flex-col items-center justify-center">
            <div class="w-full flex justify-between mb-2">
                <span class="font-bold">Occupancy</span>
                <i class="ph ph-caret-down text-gray-500"></i>
            </div>
            <div class="w-full grid grid-cols-3 gap-3 text-center mb-4">
                <div class="bg-gray-800 rounded-xl p-3">
                    <p class="text-xs text-gray-400">Occupied</p>
                    <p class="text-lg font-bold">{{ occupied_spots|default:0 }}</p>
                </div>
                <div class="bg-gray-800 rounded-xl p-3">
                    <p class="text-xs text-gray-400">Empty</p>
                    <p class="text-lg font-bold">{{ free_spots|default:0 }}</p>
                </div>
                <div class="bg-gray-800 rounded-xl p-3">
                    <p class="text-xs text-gray-400">Total</p>
                    <p class="text-lg font-bold">{{ total_spots|default:0 }}</p>
                </div>
            </div>
            <h2 class="text-3xl font-bold mb-4">{{ occupancy_rate|default:0 }}%</h2>
            <div class="w-40 h-40 relative">
                <canvas id="occupancyChart" data-occupied="{{ occupied_spots|default:0 }}" data-free="{{ free_spots|default:0 }}"></canvas>
                <!-- Center Text Overlay -->
                <div class="absolute inset-0 flex items-center justify-center flex-col">
                    <span class="text-xs text-gray-400">Total</span>
                    <span class="font-bold">{{ total_spots|default:0 }}</span>
                </div>
            </div>
        </div>

        <!-- Splitting / Small Gauges -->
        <div class="neo-card p-6 lg:col-span-2">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold">Zone Status</h3>
                <i class="ph ph-dots-three text-gray-500"></i>
            </div>
            <div class="flex justify-around items-center">
                <!-- Gauge 1 -->
                <div class="text-center">
                    <div class="w-20 h-20 rounded-full border-4 border-purple-500 flex items-center justify-center mb-2">
                        <span class="font-bold">20</span>
                    </div>
                    <p class="text-xs text-gray-400">Zone A</p>
                </div>
                <!-- Gauge 2 -->
                <div class="text-center">
                    <div class="w-20 h-20 rounded-full border-4 border-teal-400 flex items-center justify-center mb-2">
                        <span class="font-bold">50</span>
                    </div>
                    <p class="text-xs text-gray-400">Zone B</p>
                </div>
                <!-- Gauge 3 -->
                <div class="text-center">
                    <div class="w-20 h-20 rounded-full border-4 border-pink-500 flex items-center justify-center mb-2">
                        <span class="font-bold">20</span>
                    </div>
                    <p class="text-xs text-gray-400">Zone C</p>
                </div>
            </div>
        </div>

        <!-- Scalable Analytics -->
        <div class="neo-card p-6">
            <h3 class="font-bold mb-4">Live Traffic</h3>
            <div class="h-32">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>
</main>

<script>
    // --- Chart JS Implementation ---
    
    // 1. Occupancy Donut Chart
    const occupancyCanvas = document.getElementById('occupancyChart');
    if (occupancyCanvas) {
        const occupied = Number(occupancyCanvas.dataset.occupied || 0);
        const free = Number(occupancyCanvas.dataset.free || 0);
        const ctxDonut = occupancyCanvas.getContext('2d');

        new Chart(ctxDonut, {
            type: 'doughnut',
            data: {
                labels: ['Occupied', 'Free'],
                datasets: [{
                    data: [occupied, free],
                    backgroundColor: ['#c084fc', '#374151'], // Purple and Gray
                    borderWidth: 0,
                    cutout: '80%'
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                responsive: true,
                maintainAspectRatio: true
            }
        });
    }

    // 2. Traffic Line Chart
    // Fetch data from our Django API
    fetch('/api/stats/')
        .then(response => response.json())
        .then(data => {
            const ctxLine = document.getElementById('trafficChart').getContext('2d');
            
            // Create gradient
            let gradient = ctxLine.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(168, 85, 247, 0.5)'); // Purple
            gradient.addColorStop(1, 'rgba(168, 85, 247, 0)');

            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Cars',
                        data: data.data,
                        borderColor: '#a855f7',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: 0 }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        });
</script>
{% endblock %}